{% extends "frontend/layout/master.html" %}
{% load static %}

{% block content %}
<style>
  .related-posts .blog-card {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .related-posts .card-img {
    position: relative;
    width: 100%;
    height: 250px;
    overflow: hidden;
  }
   
  .related-posts .card-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .related-posts .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  .related-posts .card-title {
    margin-top: auto;
    margin-bottom: 15px;
  }
  
  .comment-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 20px;
  }
  
  .comment-avatar .avatar__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .comment {
    display: flex;
    align-items: flex-start;
  }
  
  .comment-body {
    flex: 1;
  }

  /* Add new styles for article content */
  .card-text {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
    max-width: 100%;
    line-height: 1.8;
    direction: rtl;
  }
</style>

<section class="breadcrumb-area bread-bg-9">
  <div class="breadcrumb-wrap">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6">
          <div class="breadcrumb-content">
            <div class="section-heading">
              <h2 class="sec__title text-white">{{ post.title }}</h2>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="breadcrumb-list text-end">
            <ul class="list-items">
              <li><a href="{% url 'home:index' %}">الرئيسية</a></li>
              <li><a href="{% url 'blog:post_list' %}">المدونة</a></li>
              <li>{{ post.title }}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="bread-svg-box">
    <svg class="bread-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 10" preserveAspectRatio="none">
      <polygon points="100 0 50 10 0 0 0 10 100 10"></polygon>
    </svg>
  </div>
</section>

<section class="card-area section--padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <div class="card-item blog-card blog-card-layout-2 blog-single-card mb-5">
          <div class="card-img before-none">
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="{{ post.title }}" />
            {% else %}
            <img src="{% static 'images/blog-img.jpg' %}" alt="{{ post.title }}" />
            {% endif %}
          </div>
          <div class="card-body px-0 pb-0">
            <div class="post-categories">
              <a href="{% url 'blog:post_list' %}?category={{ post.category.id }}" class="badge">{{ post.category.name }}</a>
              {% if post.tags.all %}
              {% for tag in post.tags.all %}
              <a href="{% url 'blog:post_list' %}?tag={{ tag.id }}" class="badge">{{ tag.name }}</a>
              {% endfor %}
              {% endif %}
            </div>
            <h3 class="card-title font-size-28">{{ post.title }}</h3>
            <div class="post-meta d-flex align-items-center pb-3">
              <div class="author-avatar">
                {% if post.author.profile_image %}
                <img class="rounded-circle" src="{{ post.author.profile_image.url }}" alt="{{ post.author.username }}" style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #ff7e01;" />
                {% else %}
                <img class="rounded-circle" src="{% static 'images/small-team1.jpg' %}" alt="{{ post.author.username }}" style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #ff7e01;" />
                {% endif %}
              </div>
              <div class="post-meta-content ms-3">
                <a href="#" class="author__title">{{ post.author.username }}</a>
                <p class="post-meta-info">
                  <span>{{ post.published_at|date }}</span>
                  <span class="post-dot"></span>
                  <span class="badge bg-warning text-dark" style="font-size: 16px; padding: 8px 12px;"><i class="la la-eye"></i> {{ post.views }} مشاهدة</span>
                  <span class="post-dot"></span>
                  <span class="badge bg-info text-white" style="font-size: 16px; padding: 8px 12px;"><i class="la la-comments"></i> {{ comments|length }} تعليق</span>
                </p>
              </div>
            </div>
            <div class="section-block"></div>
            <div class="card-text py-3">
              {{ post.content|linebreaks }}
            </div>
          </div>
        </div>

        {% if related_posts %}
        <div class="related-posts mt-5">
          <h3 class="title stroke-shape mb-4">مقالات ذات صلة</h3>
          <div class="row">
            {% for related_post in related_posts %}
            <div class="col-lg-6">
              <div class="card-item blog-card">
                <div class="card-img">
                  {% if related_post.image %}
                  <img src="{{ related_post.image.url }}" alt="{{ related_post.title }}" />
                  {% else %}
                  <img src="{% static 'images/blog-img.jpg' %}" alt="{{ related_post.title }}" />
                  {% endif %}
                  <div class="post-format icon-element">
                    <i class="la la-photo"></i>
                  </div>
                  <div class="card-body">
                    <div class="post-categories">
                      {% if related_post.category %}
                      <span class="badge">{{ related_post.category.name }}</span>
                      {% endif %}
                    </div>
                    <h3 class="card-title line-height-26">
                      <a href="{% url 'blog:post_detail' related_post.slug %}" class="text-white">{{ related_post.title }}</a>
                    </h3>
                    <p class="card-meta">
                      <span class="post__date">{{ related_post.published_at|date }}</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if comments %}
        <div class="comments-list pt-5">
          <h3 class="title font-size-20">آخر التعليقات ({{ comments.paginator.count }})</h3>
          {% for comment in comments %}
          <div class="comment {% if not forloop.last %}border-bottom border-top-0 border-left-0 border-right-0 pb-4 mb-4{% endif %}">
            <div class="comment-avatar">
              {% if comment.author.image %}
              <img class="avatar__img" alt="{{ comment.author.username }}" src="{{ comment.author.image.url }}">
              {% else %}
              <img class="avatar__img" alt="{{ comment.author.username }}" src="{% static 'frontend/images/team8.jpg' %}">
              {% endif %}
            </div>
            <div class="comment-body">
              <div class="meta-data">
                <h3 class="comment__author">{{ comment.author.username }}</h3>
                <div class="meta-data-inner d-flex">
                  <span class="comment__date">
                    {{ comment.created_at|date }}
                  </span>
                </div>
              </div>
              <p class="comment-content">
                {{ comment.content }}
              </p>
            </div>
          </div>
          {% endfor %}
          
          {% if comments.paginator.num_pages > 1 %}
          <div class="comments-pagination text-center mt-4">
            {% if comments.has_previous %}
            <a href="?comment_page={{ comments.previous_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="load-more-btn me-2">
              <i class="la la-angle-right"></i> التعليقات السابقة
            </a>
            {% endif %}
            {% if comments.has_next %}
            <a href="?comment_page={{ comments.next_page_number }}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}" class="load-more-btn">
              <i class="la la-refresh"></i> المزيد من التعليقات
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}

        <div class="comment-forum pt-5">
          <div class="form-box">
            <div class="form-title-wrap">
              <h3 class="title">اكتب تعليقاً</h3>
            </div>
            <div class="form-content">
              <div class="contact-form-action">
                <form method="post">
                  {% csrf_token %}
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="input-box">
                        <div class="form-group mb-0">
                          <textarea class="message-control form-control" name="content" placeholder="اكتب تعليقك هنا"></textarea>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="btn-box pt-3">
                        <button type="submit" class="theme-btn">إرسال التعليق</button>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="sidebar mb-0">
          <div class="sidebar-widget">
            <h3 class="title stroke-shape">بحث</h3>
            <div class="contact-form-action">
              <form action="{% url 'blog:post_list' %}" method="get">
                <div class="input-box">
                  <div class="form-group mb-0">
                    <input class="form-control pl-3" type="text" name="search" placeholder="ابحث هنا...">
                    <button class="search-btn" type="submit"><i class="la la-search"></i></button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="sidebar-widget">
            <h3 class="title stroke-shape">التصنيفات</h3>
            <div class="sidebar-category">
              {% for category in categories %}
              <div class="custom-checkbox">
                <input type="checkbox" class="form-check-input" id="cat{{ category.id }}" 
                       {% if request.GET.category|add:"0" == category.id %}checked{% endif %}
                       onclick="window.location.href='{% url 'blog:post_list' %}{% if request.GET.category|add:"0" == category.id %}?{% else %}?category={{ category.id }}{% endif %}'">
                <label for="cat{{ category.id }}">
                  {{ category.name }} <span class="font-size-13 ms-1">({{ category.post_set.count }})</span>
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="sidebar-widget">
            <div class="section-tab section-tab-2 pb-3">
              <ul class="nav nav-tabs justify-content-center" id="myTab3" role="tablist">
                <li class="nav-item">
                  <a class="nav-link {% if current_tab == 'recent' %}active{% endif %}" 
                     id="recent-tab" href="?tab=recent" role="tab">
                    الأخيرة
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link {% if current_tab == 'popular' or not current_tab %}active{% endif %}" 
                     id="popular-tab" href="?tab=popular" role="tab">
                    جمع
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link {% if current_tab == 'new' %}active{% endif %}" 
                     id="new-tab" href="?tab=new" role="tab">
                    جديد
                  </a>
                </li>
              </ul>
            </div>
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active">
                {% for post in filtered_posts %}
                <div class="card-item card-item-list recent-post-card {% if forloop.last %}mb-0{% endif %}">
                  <div class="card-img">
                    <a href="{% url 'blog:post_detail' post.slug %}" class="d-block">
                      {% if post.image %}
                      <img src="{{ post.image.url }}" alt="{{ post.title }}" />
                      {% else %}
                      <img src="{% static 'images/blog-img.jpg' %}" alt="{{ post.title }}" />
                      {% endif %}
                    </a>
                  </div>
                  <div class="card-body">
                    <h3 class="card-title">
                      <a href="{% url 'blog:post_detail' post.slug %}">{{ post.title }}</a>
                    </h3>
                    <p class="card-meta">
                      <span class="post__date">{{ post.published_at|date }}</span>
                      <span class="post-dot"></span>
                      <span class="post__time">{{ post.views }} مشاهدة</span>
                    </p>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="sidebar-widget">
            <h3 class="title stroke-shape">أرشيف</h3>
            <div class="sidebar-list">
              <ul class="list-items">
                {% for archive in archive_data %}
                <li>
                  <i class="la la-dot-circle me-2 text-color"></i>
                  <a href="?year={{ archive.year }}&month={{ archive.month|date:'n' }}">
                    {% with month_name=archive.month|date:'F' %}
                    {% if month_name == 'January' %}يناير
                    {% elif month_name == 'February' %}فبراير
                    {% elif month_name == 'March' %}مارس
                    {% elif month_name == 'April' %}أبريل
                    {% elif month_name == 'May' %}مايو
                    {% elif month_name == 'June' %}يونيو
                    {% elif month_name == 'July' %}يوليو
                    {% elif month_name == 'August' %}أغسطس
                    {% elif month_name == 'September' %}سبتمبر
                    {% elif month_name == 'October' %}أكتوبر
                    {% elif month_name == 'November' %}نوفمبر
                    {% elif month_name == 'December' %}ديسمبر
                    {% endif %}
                    {{ archive.year }}
                    {% endwith %}
                    <span class="mr-2">({{ archive.count }})</span>
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="sidebar-widget">
            <h3 class="title stroke-shape">سحابة الوسم</h3>
            <ul class="tag-list">
              {% for tag in tags %}
              <li>
                <a href="?tag={{ tag.id }}" 
                   class="{% if request.GET.tag|stringformat:'s' == tag.id|stringformat:'s' %}active{% endif %}"
                   style="{% if request.GET.tag|stringformat:'s' == tag.id|stringformat:'s' %}background-color: #ff7e01; color: white; border-color: #ff7e01;{% endif %}">
                  {{ tag.name }}
                </a>
              </li>
              {% endfor %}
              {% if request.GET.tag %}
              <li>
                <a href="?" class="text-danger"><i class="la la-times"></i> إزالة الفلتر</a>
              </li>
              {% endif %}
            </ul>
          </div>

          <div class="sidebar-widget">
            <h3 class="title stroke-shape">معلومات عنا</h3>
            <div class="sidebar-about">
              <div class="sidebar-about-img">
                <img src="{% static 'frontend/images/blog-list.jpg' %}" alt="" />
                <p class="font-size-28 font-weight-bold text-white">
                  Trizen
                </p>
              </div>
              <p class="pt-3">
                لكن لا بد لي من أن أوضح لكم كيف ولدت كل هذه الفكرة الخاطئة ،
                وأشرح التعاليم الفعلية للمستكشف العظيم للحيوية ، حتى تكون
                لذة المجهود العظيم ، والحزن:
              </p>
            </div>
          </div>

          <div class="sidebar-widget">
            <h3 class="title stroke-shape">اتبع واتصل</h3>
            <ul class="social-profile">
              <li>
                <a href="#"><i class="lab la-facebook-f"></i></a>
              </li>
              <li>
                <a href="#"><i class="lab la-twitter"></i></a>
              </li>
              <li>
                <a href="#"><i class="lab la-instagram"></i></a>
              </li>
              <li>
                <a href="#"><i class="lab la-linkedin-in"></i></a>
              </li>
            </ul>
          </div>
        </div>
        <!-- end sidebar -->
      </div>
      <!-- end col-lg-4 -->
    </div>
    <!-- end row -->
  </div>
  <!-- end container -->
</section>
<!-- end card-area -->

<div class="section-block"></div>

<!-- ================================
START INFO AREA
================================= -->
<section class="info-area info-bg padding-top-90px padding-bottom-70px">
  <div class="container">
    <div class="row">
      <div class="col-lg-4 responsive-column">
        <a href="#" class="icon-box icon-layout-2 d-flex">
          <div class="info-icon flex-shrink-0 bg-rgb text-color-2">
            <i class="la la-phone"></i>
          </div>
          <div class="info-content">
            <h4 class="info__title">تحتاج مساعدة؟ اتصل بنا</h4>
            <p class="info__desc">جزر لوريم إيبسوم ، حسومات معززة</p>
          </div>
        </a>
      </div>
      <div class="col-lg-4 responsive-column">
        <a href="#" class="icon-box icon-layout-2 d-flex">
          <div class="info-icon flex-shrink-0 bg-rgb-2 text-color-3">
            <i class="la la-money"></i>
          </div>
          <div class="info-content">
            <h4 class="info__title">المدفوعات</h4>
            <p class="info__desc">جزر لوريم إيبسوم ، حسومات معززة</p>
          </div>
        </a>
      </div>
      <div class="col-lg-4 responsive-column">
        <a href="#" class="icon-box icon-layout-2 d-flex">
          <div class="info-icon flex-shrink-0 bg-rgb-3 text-color-4">
            <i class="la la-times"></i>
          </div>
          <div class="info-content">
            <h4 class="info__title">سياسة الإلغاء</h4>
            <p class="info__desc">جزر لوريم إيبسوم ، حسومات معززة</p>
          </div>
        </a>
      </div>
    </div>
  </div>
</section>
<!-- end info-area -->


{% endblock %}