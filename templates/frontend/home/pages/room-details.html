{% extends "frontend/layout/master.html" %}
{% block extra_css %}
   
    <style>
    .messages .alert {
    padding: 15px; /* زيادة حجم المساحة الداخلية للرسالة */
    margin-bottom: 15px; /* إضافة مسافة أسفل كل رسالة */
    border: 2px solid; /* إضافة حدود سميكة */
    border-radius: 8px; /* جعل الزوايا مستديرة أكثر */
    font-weight: bold; /* جعل النص أكثر جرأة */
}

.messages .alert-success {
    color: #155724; /* لون نص النجاح (أخضر داكن) */
    background-color: #d4edda; /* لون خلفية النجاح (أخضر فاتح) */
    border-color: #c3e6cb; /* لون حدود النجاح (أخضر أفتح) */
}

.messages .alert-error {
    color: #721c24; /* لون نص الخطأ (أحمر داكن) */
    background-color: #f8d7da; /* لون خلفية الخطأ (أحمر فاتح) */
    border-color: #f5c6cb; /* لون حدود الخطأ (أحمر أفتح) */
}

/* يمكنك إضافة أنماط لأنواع الرسائل الأخرى مثل warning و info إذا كنت تستخدمها */
.messages .alert-warning {
    color: #85640a;
    background-color: #fff3cd;
    border-color: #ffeeba;
}

.messages .alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}
</style>
 {% endblock extra_css %}
{% block content %}

    <!-- ================================
    START ROOM DETAIL BREAD
================================= -->
<section class="room-detail-bread">
  <div class="full-width-slider carousel-action">
    {% for image in image %}
    <div class="full-width-slide-item">
      <img src="{{ image.image.url }}" alt="{{ room.name }}" />
    </div>
    {% endfor %}
  </div>
  <!-- end full-width-slider -->
</section>
<!-- end room-detail-bread -->
<!-- ================================
END ROOM DETAIL BREAD
================================= -->

<!-- ================================
START TOUR DETAIL AREA
================================= -->
<section class="tour-detail-area padding-bottom-90px">
  <div
    class="single-content-navbar-wrap menu section-bg"
    id="single-content-navbar"
  >
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="single-content-nav" id="single-content-nav">
            <ul>
              <li>
                <a
                  data-scroll="description"
                  href="#description"
                  class="scroll-link active"
                  >وصف</a
                >
              </li>
              <li>
                <a
                  data-scroll="services"
                  href="#services"
                  class="scroll-link"
                  >خدمات</a
                >
              </li>
              <li>
                <a
                  data-scroll="amenities"
                  href="#amenities"
                  class="scroll-link"
                  >وسائل الراحة</a
                >
              </li>
              <li>
                <a
                  data-scroll="location-map"
                  href="#location-map"
                  class="scroll-link"
                  >خريطة</a
                >
              </li>
              <li>
                <a data-scroll="reviews" href="#reviews" class="scroll-link"
                  >المراجعات</a
                >
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- end single-content-navbar-wrap -->
  <div class="single-content-box">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <div class="single-content-wrap padding-top-60px">
            <div id="description" class="page-scroll">
              <div class="single-content-item pb-4">
                <h3 class="title font-size-26">{{ room.name }}</h3>
                <p class="pt-2">
                 <span class="badge text-bg-warning text-white font-size-16">
    {% if average_rating %}
        {{ average_rating }}
    {% else %}
        لا يوجد تقييمات بعد
    {% endif %}
</span>
                  <span>({{ reviews.paginator.count }} تعليقات)</span>
                </p>
              </div>
              <!-- end single-content-item -->
              <div class="section-block"></div>
              <div
                class="single-content-item padding-top-30px padding-bottom-40px"
              >
                <h3 class="title font-size-20">وصف</h3>
                <p class="py-3">
                  {{ room.description }}
                </p>
                <p class="pb-4">

                </p>
                <h3 class="title font-size-15 font-weight-medium pb-3">
                  قواعد المنزل
                </h3>
                <ul class="list-items">
                  <li>
                    <i class="la la-dot-circle me-2"></i>ممنوع التدخين
                    والحفلات والمناسبات.
                  </li>

                </ul>
              </div>
              <!-- end single-content-item -->
              <div class="section-block"></div>
            </div>
            <!-- end description -->
            <div id="services" class="page-scroll">
              <div
                class="single-content-item padding-top-40px padding-bottom-40px"
              >
                <h3 class="title font-size-20">خدمات ووسائل الراحة </h3>
<div class="row pt-4">
  {% for service in services %}
  {% if service.additional_fee %}
  <!-- end col-lg-4 -->
  <div class="col-lg-4 responsive-column">
    <div
      class="single-tour-feature d-flex align-items-center mb-3"
    >
      <div
        class="single-feature-icon icon-element ms-0 flex-shrink-0 me-3"
      >
        <i class="la {{service.icon}}"></i>
      </div>
      <div class="single-feature-titles">
        <h3 class="title font-size-15 font-weight-medium">
        {{service.name}}
        </h3>
      </div>
    </div>
    <!-- end single-tour-feature -->
  </div>
  {% endif %}  <!-- نهاية الشرط -->
  <!-- end col-lg-4 -->
  {% endfor %}
</div>
                <!-- end row -->
              </div>
              <!-- end single-content-item -->
              <div class="section-block"></div>
            </div>


            <!-- end location-map -->
                       <!-- end location-map -->
            <div id="reviews" class="page-scroll">
              <div
                class="single-content-item padding-top-40px padding-bottom-40px"
              >
                <h3 class="title font-size-20">المراجعات</h3>
                <div class="review-container padding-top-30px">
                  <div class="row align-items-center">
                    <div class="col-lg-4">
                      <div class="review-summary">
                        <h2>
                          {% if average_rating %}
                            {{ average_rating }}
                          {% else %}
                            0.0
                          {% endif %}
                          <span>/5</span>
                        </h2>
                        <p>
                          {% if average_rating >= 4.5 %}
                            ممتاز
                          {% elif average_rating >= 3.5 %}
                            جيد جداً
                          {% elif average_rating >= 2.5 %}
                            جيد
                          {% elif average_rating >= 1.5 %}
                            مقبول
                          {% else %}
                            ضعيف
                          {% endif %}
                        </p>
                        <span>مرتكز على {{ reviews.paginator.count }} تقييم</span>
                      </div>
                    </div>
                    <!-- end col-lg-4 -->
                    <div class="col-lg-8">
                      <div class="review-bars">
                        <!-- تم إزالة أشرطة التقييمات الفردية كما هو مطلوب -->
                        <p>لا يوجد تقييمات فرعية للخدمات، الموقع، إلخ. في نموذج مراجعة الغرفة هذا.</p>
                      </div>
                    </div>
                    <!-- end col-lg-8 -->
                  </div>
                </div>
              </div>
              <!-- end single-content-item -->
              <div class="section-block"></div>
            </div>
            <!-- end reviews -->
            <div class="review-box">
              <div class="single-content-item padding-top-40px">
                <h3 class="title font-size-20">عرض {{ reviews.paginator.count }} تقييمات من النزلاء</h3>
                <div class="comments-list padding-top-50px">
                  <ul class="list-items">
                    {% for review in reviews %}
                    <li class="comment">
                      <div class="comment-avatar">
                        <img
                          class="avatar__img"
                          alt="صورة المستخدم"
                          src="" <!-- استخدام static tag هنا -->
                        />
                      </div>
                      <div class="comment-body">
                        <div class="meta-data">
                          <h3 class="comment__author">{{ review.user.get_full_name }}</h3>
                          <div class="meta-data-inner d-flex align-items-center">
                            <span class="ratings d-flex align-items-center me-1">
                              {% for i in stars %}
                                {% if i <= review.rating %}
                                  <i class="la la-star"></i>
                                {% else %}
                                  <i class="la la-star-o"></i>
                                {% endif %}
                              {% endfor %}
                            </span>
                            <p class="comment__date">{{ review.created_at|date:"d M Y" }}</p>
                          </div>
                        </div>
                        <p class="comment-content">
                          {{ review.review }}
                        </p>
                        <!-- يمكنك إضافة قسم "الرد" إذا كنت تريد ميزة الرد على المراجعات -->
                      </div>
                    </li>
                    <!-- end comments -->
                    {% empty %}
                      <li>
                        <p>لا يوجد مراجعات حتى الآن.</p>
                      </li>
                    {% endfor %}
                  </ul>

                  {% if reviews.has_next %}
                  <div class="btn-box load-more text-center">
                    <button
                      class="theme-btn theme-btn-small theme-btn-transparent"
                      type="button"
                      id="load-more-reviews"
                      data-next-page="{{ reviews.next_page_number }}"
                      data-room-id="{{ room.id }}"
                    >
                      تحميل المزيد من المراجعة
                    </button>
                  </div>
                  {% endif %}

                </div>
                <!-- end comments-list -->
                <!-- تم إزالة نموذج التقييم ذو الفئات لأنه لا يتطابق مع نموذج RoomReview الخاص بك -->
               <div class="comment-forum padding-top-40px">
               {% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
    <div class="form-box">
        <div class="form-title-wrap">
            <h3 class="title">أكتب مراجعة</h3>
        </div>
        <!-- form-title-wrap -->
        <div class="form-content">
            <div class="contact-form-action">
                <form method="post"> <form method="post">
                    {% csrf_token %} <form method="post">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="input-box">
                                    <label class="label-text">تقييم الغرفة</label>
                                    <div class="rate-stars-option">
                                        {% for i in stars %}
                                            <input type="radio" name="rating" value="{{ i }}" id="rating-{{ i }}" {% if i == 5 %}checked{% endif %} >
                                            <label for="rating-{{ i }}"></label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="input-box">
                                    <label class="label-text">رسالة</label>
                                    <div class="form-group">
                                        <span class="la la-pencil form-icon"></span>
                                        {{ form.review }} <span class="la la-pencil form-icon"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="btn-box">
                                    <button type="submit" class="theme-btn">
                                        إرسال المراجعة
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </form>
            </div>
            <!-- end contact-form-action -->
        </div>
        <!-- end form-content -->
    </div>
    <!-- end form-box -->
</div>
                <!-- end comment-forum -->
              </div>
              <!-- end single-content-item -->
            </div>
            <!-- end review-box -->
            <!-- end review-box -->
          </div>
          <!-- end single-content-wrap -->
        </div>
        <!-- end col-lg-8 -->
        <div class="col-lg-4">
          <div class="sidebar single-content-sidebar mb-0">
            <div class="sidebar-widget single-content-widget">
              <h3 class="title stroke-shape">الحجز الخاص بك</h3>
              <div class="sidebar-widget-item">
                <div class="contact-form-action">
                  <form method="POST" action="{% url 'rooms:room_detail' room.id %}" id="bookingForm">
                    {% csrf_token %}
                    <div class="input-box">
                      <label class="label-text">تاريخ تسجيل الدخول</label>
                      <div class="form-group">
                        <span class="la la-calendar form-icon"></span>
                        <input
                          type="text"
                          id="check_in_datepicker"
                          name="check_in_date"
                          value="{{ check_in|date:'Y-m-d' }}"
                          required
                          readonly
                          style="background-color: #f9f9f9; direction: rtl;"
                        />
                      </div>
                    </div>
                    <div class="input-box">
                      <label class="label-text">تاريخ تسجيل الخروج</label>
                      <div class="form-group">
                        <span class="la la-calendar form-icon"></span>
                        <input
                          type="text"
                          id="check_out_datepicker"
                          name="check_out_date"
                          value="{{ check_out|date:'Y-m-d' }}"
                          required
                          readonly
                          style="background-color: #f9f9f9; direction: rtl;"
                        />
                      </div>
                    </div>
                    <div class="input-box">
                      <label class="label-text">عدد الغرف</label>
                      <div class="form-group">
                        <span class="la la-bed form-icon"></span>
                        <input
                          class="form-control"
                          type="number"
                          name="room_number"
                          id="roomNumber"
                          min="1"
                          value="1"
                          required
                        />
                      </div>
                    </div>
                    <div class="input-box">
                      <label class="label-text">عدد الأشخاص</label>
                      <div class="form-group">
                        <span class="la la-user form-icon"></span>
                        <input
                          class="form-control"
                          type="number"
                          name="adult_number"
                          id="adultNumber"
                          min="1"
                          value="1"
                          required
                        />
                      </div>
                    </div>
                    
                    <!-- Extra Services Section -->
                    <div class="sidebar-widget-item py-4">
                      <h3 class="title stroke-shape">خدمات إضافية</h3>
                      <div class="extra-service-wrap">
                        {% for service in services %}
                        {% if service.additional_fee %}
                        <div class="custom-checkbox">
                          <input
                            type="checkbox"
                            class="form-check-input service-checkbox"
                            name="extra_services"
                            value="{{ service.id }}"
                            data-price="{{ service.additional_price }}"
                          />
                          <label class="d-flex justify-content-between align-items-center">
                            {{ service.name }}
                            <span class="text-black font-weight-regular">${{ service.additional_price }}</span>
                          </label>
                        </div>
                        {% endif %}
                        {% endfor %}
                      </div>
                    </div>

                    <div class="total-price pt-3">
                      <p class="text-black">السعر الخاص</p>
                      <p class="d-flex align-items-center">
                        <span class="font-size-17 text-black">$</span>
                        <input
                          type="text"
                          id="totalPrice"
                          name="total_price"
                          class="num"
                          value="{{ price }}"
                          readonly="readonly"
                        />
                        <span>/ لكل ليله</span>
                      </p>
                    </div>

                    <div class="btn-box pt-2">
                      <button type="submit" class="theme-btn text-center w-100 mb-2">
                        <i class="la la-check-circle mr-2 font-size-18"></i>متابعة الى الدفع
                      </button>
                    </div>
                    <a href="{% url 'ShoppingCart:add_to_cart' room.id %}?check_in_date={{ check_in }}&check_out_date={{ check_out }}" 



                    id="addToCartBtn"
                 
                 
                    class="theme-btn text-center w-100 mb-2">
                 
                 
                   <i class="la la-shopping-cart mr-2 font-size-18"></i>اضافة الى عربة التسوق
                 
                 
                 </a>
                 
                 
                  </form>
              </div>
              <!-- end sidebar-widget-item -->
            </div>
            <!-- end sidebar-widget -->

        </div>
            <!-- end sidebar-widget -->
          </div>
          <!-- end sidebar -->
        </div>
        <!-- end col-lg-4 -->
      </div>
      <!-- end row -->
    </div>
    <!-- end container -->
  </div>
  <!-- end single-content-box -->
</section>
<!-- end tour-detail-area -->
<!-- ================================
END TOUR DETAIL AREA
================================= -->

<div class="section-block"></div>

<!-- ================================
START RELATE TOUR AREA
================================= -->
<section class="related-tour-area section--padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="section-heading text-center">
          <h2 class="sec__title">غرف اخرى</h2>
          <p class="sec__desc">يمكن أيضا أن يكون ممتعا بالنسبة لك</p>
        </div>
        <!-- end section-heading -->
      </div>
      <!-- end col-lg-12 -->
    </div>
    <!-- end row -->
    <div class="row padding-top-50px">

      <!-- end col-lg-6 -->
      <div class="col-lg-6">
        <div class="card-item room-card">
          <div class="card-img-carousel carousel-action carousel--action">
            <div class="card-img">
              <a href="room-details.html" class="d-block">
                <img src"" alt="hotel-img" />
              </a>
            </div>
            <div class="card-img">
              <a href="room-details.html" class="d-block">
                <img src="" alt="hotel-img" />
              </a>
            </div>
            <div class="card-img">
              <a href="room-details.html" class="d-block">
                <img src="" alt="hotel-img" />
              </a>
            </div>
          </div>
          <div class="card-body">
            <div class="card-price pb-2">
              <p>
                <span class="price__from">من عند</span>
                <span class="price__num">$45.00</span>
              </p>
            </div>
            <h3 class="title font-size-26">
              <a href="room-details.html"
                >صالة نوم مشتركة للذكور بسريرين قياسيين</a
              >
            </h3>
            <p class="card-text pt-2">
              Lorem ipsum dolor sit amet، consectetur adipiscing elit. سأفتح
              الكدح الشاق للغاية ، وميزة deleniti المخترع هنا من الإزعاج منا
              ، لا أكره أن أسأل! من السهل فتح قضية تجنب الخطأ.
            </p>
            <div class="card-attributes pt-3 pb-4">
              <ul class="d-flex align-items-center">
                <li class="d-flex align-items-center">
                  <i class="la la-bed"></i><span>2 سرير</span>
                </li>
                <li class="d-flex align-items-center">
                  <i class="la la-building"></i
                  ><span>24 قدم<sup>2</sup></span>
                </li>
                <li class="d-flex align-items-center">
                  <i class="la la-bathtub"></i><span>2 حمام</span>
                </li>
              </ul>
            </div>
            <div class="card-btn">
              <a
                href="room-details.html"
                class="theme-btn theme-btn-transparent"
                >احجز الآن</a
              >
            </div>
          </div>
        </div>
        <!-- end card-item -->
      </div>
      <!-- end col-lg-6 -->
    </div>
    <!-- end row -->
  </div>
  <!-- end container -->
</section>
<!-- end related-tour-area -->
<!-- ================================
END RELATE TOUR AREA
================================= -->

<!-- ================================
START CTA AREA
================================= -->

<!-- end cta-area -->
<!-- ================================
END CTA AREA
================================= -->


<!-- ... existing code ... -->

{% block extra_js %}



<script>


  document.addEventListener("DOMContentLoaded", function () {


    let basePrice = parseFloat("{{ price }}");


    let totalPriceInput = document.getElementById("totalPrice");


    let addToCartBtn = document.getElementById("addToCartBtn");





    function updateCartUrl() {


      let selectedServices = [];


      document.querySelectorAll(".service-checkbox:checked").forEach((checkbox) => {


        selectedServices.push(checkbox.value); 


      });





      let baseUrl = "{% url 'ShoppingCart:add_to_cart' room.id %}?check_in_date={{ check_in }}&check_out_date={{ check_out }}";


      if (selectedServices.length > 0) {


        baseUrl += "&extra_services=" + selectedServices.join(",");


      }





      addToCartBtn.setAttribute("href", baseUrl);


    }





    document.querySelectorAll(".service-checkbox").forEach((checkbox) => {


      checkbox.addEventListener("change", function () {


        let additionalFee = parseFloat(this.getAttribute("data-price")) || 0;





        if (this.checked) {


          basePrice += additionalFee;


        } else {


          basePrice -= additionalFee;


        }





        totalPriceInput.value = basePrice.toFixed(2);


        updateCartUrl(); 


      });


    });





    updateCartUrl();


  });


</script>
<script>
$(document).ready(function() {
    // Initialize datepicker for check-in date
    $("#check_in_datepicker").datepicker({
        dateFormat: "yy-mm-dd",
        minDate: 0,
        onSelect: function(dateText) {
            $("input[name='check_in_date']").val(dateText);
            // Set minimum date for checkout datepicker
            let checkInDate = $(this).datepicker('getDate');
            $("#check_out_datepicker").datepicker('option', 'minDate', new Date(checkInDate.getTime() + 24*60*60*1000));
            
            // Reset check-out date if it's before check-in date
            let checkOutDate = $("#check_out_datepicker").datepicker('getDate');
            if (checkOutDate <= checkInDate) {
                $("#check_out_datepicker").val('');
            }
        }
    });
    $('#load-more-reviews').on('click', function(e) {
      e.preventDefault();
      var button = $(this);
      var nextPage = button.data('next-page');
      var roomId = button.data('room-id');

      if (nextPage) {
        $.ajax({
          url: `/rooms/room_detail/${roomId}/?page=${nextPage}`,
          type: 'GET',
          dataType: 'html',
          success: function(data) {
            var newReviewsHtml = $(data).find('.comments-list .list-items').html();
            $('.comments-list .list-items').append(newReviewsHtml);

            var nextButtonHtml = $(data).find('#load-more-reviews');
            if (nextButtonHtml.length > 0) {
              button.data('next-page', nextButtonHtml.data('next-page'));
            } else {
              button.remove();
            }
          },
          error: function(xhr, status, error) {
            console.error("Error loading reviews:", error);
          }
        });
      } else {
        button.remove();
      }
    });

    // Initialize datepicker for check-out date
    $("#check_out_datepicker").datepicker({
        dateFormat: "yy-mm-dd",
        minDate: 1,
        onSelect: function(dateText) {
            $("input[name='check_out_date']").val(dateText);
        }
    });

    // Handle form submission
    $('#bookingForm').on('submit', function(e) {
        e.preventDefault();
        
        // Get form values
        const checkIn = $("input[name='check_in_date']").val();
        const checkOut = $("input[name='check_out_date']").val();
        const roomNumber = parseInt($('#roomNumber').val());
        const adultNumber = parseInt($('#adultNumber').val());
        const maxCapacity = {{ room.max_capacity }};
        
        // Comprehensive validation
        let errors = [];
        
        if (!checkIn) {
            errors.push("يرجى تحديد تاريخ الدخول");
        }
        
        if (!checkOut) {
            errors.push("يرجى تحديد تاريخ الخروج");
        }
        
        if (checkIn && checkOut) {
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (checkInDate < today) {
                errors.push("لا يمكن اختيار تاريخ دخول في الماضي");
            }
            
            if (checkOutDate <= checkInDate) {
                errors.push("يجب أن يكون تاريخ الخروج بعد تاريخ الدخول");
            }
        }
        
        if (roomNumber < 1) {
            errors.push("يجب أن يكون عدد الغرف 1 على الأقل");
        }
        
        if (adultNumber < 1) {
            errors.push("يجب أن يكون عدد الأشخاص 1 على الأقل");
        }
        
        if (adultNumber > maxCapacity) {
            errors.push(`السعة القصوى لهذا النوع من الغرف هي ${maxCapacity} أشخاص`);
        }
        
        if (errors.length > 0) {
            alert(errors.join("\n"));
            return false;
        }

        // Submit the form if validation passes
        this.submit();
    });

    });
</script>


<!-- ... existing code ... -->

{% endblock extra_js %}


{% endblock content %}