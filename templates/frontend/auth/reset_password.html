{% extends "frontend/layout/master.html" %}

{% block content %}
<style>
    :root {
        --primary-color: #646cff;
        --primary-hover: #535bf2;
        --error-color: #ff4646;
        --success-color: #00c853;
        --text-color: #213547;
        --bg-color: #f5f5f5;
        --card-bg: #ffffff;
        --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    * {
        margin: 0 auto;
        padding: 0;
        box-sizing: border-box;
    } 
    
    {% comment %} body {
        font-family: Inter, system-ui, -apple-system, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    } {% endcomment %}
    
    .container1 {
        width: 100%;
        max-width: 400px;
        padding: 20px;
        margin:1000px ,0px;
    } 
    
    .step {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px var(--shadow-color);
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .step.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
    
    h2 {
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        text-align: center;
    }
    
    .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    input {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    
    input:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .error {
        color: var(--error-color);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        min-height: 1.2em;
    }
    
    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }
    
    .btn {
        width: 100%;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 0.8rem;
    }
    
    .btn.primary {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn.primary:hover {
        background-color: var(--primary-hover);
    }
    
    .btn.secondary {
        background-color: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }
    
    .btn.secondary:hover {
        background-color: rgba(100, 108, 255, 0.1);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .success-message {
        text-align: center;
    }
    
    .success-message h2 {
        color: var(--success-color);
        margin-bottom: 1rem;
    }
    
    .success-message p {
        margin-bottom: 2rem;
        color: #666;
    }
    
    @media (max-width: 480px) {
        .container1 {
            padding: 10px;
        }
    
        .step {
            padding: 1.5rem;
        }
    
        h2 {
            font-size: 1.25rem;
        }
    }
</style>
<div class="container1">
    <!-- Step 1: Choose Recovery Method -->
    <div class="step active" id="step1">
        <h2>How would you like to recover your password?</h2>
        <div class="button-group">
            <button class="btn primary" onclick="showStep('step2')">Email</button>
            <button class="btn" disabled>Phone</button>
        </div>
    </div>

    <!-- Step 2: Email Input -->
    <div class="step" id="step2">
        <h2>Enter your email address</h2>
        <form id="emailForm">
            <div class="form-group">
                <input type="email" id="email" required placeholder="Enter your email">
                <div class="error" id="emailError"></div>
            </div>
            <button type="submit" class="btn primary">Send OTP</button>
            <button type="button" class="btn secondary" onclick="showStep('step1')">Back</button>
        </form>
    </div>

    <!-- Step 3: OTP Verification -->
    <div class="step" id="step3">
        <h2>Enter the OTP</h2>
        <p class="subtitle">We've sent a 6-digit code to your email</p>
        <form id="otpForm">
            <div class="form-group">
                <input type="text" id="otp" required maxlength="6" placeholder="Enter 6-digit OTP" pattern="[0-9]{6}">
                <div class="error" id="otpError"></div>
            </div>
            <button type="submit" class="btn primary">Verify OTP</button>
            <button type="button" class="btn secondary" onclick="showStep('step2')">Back</button>
        </form>
    </div>

    <!-- Step 4: New Password -->
    <div class="step" id="step4">
        <h2>Set New Password</h2>
        <form id="passwordForm">
            <div class="form-group">
                <input type="password" id="newPassword" required placeholder="Enter new password">
                <div class="error" id="passwordError"></div>
            </div>
            <div class="form-group">
                <input type="password" id="confirmPassword" required placeholder="Confirm new password">
                <div class="error" id="confirmPasswordError"></div>
            </div>
            <button type="submit" class="btn primary">Reset Password</button>
            <button type="button" class="btn secondary" onclick="showStep('step3')">Back</button>
        </form>
    </div>

    <!-- Success Message -->
    <div class="step" id="success">
        <div class="success-message">
            <h2>Password Reset Successfully!</h2>
            <p>You can now login with your new password.</p>
            <a class="btn primary" href="{% url "users:login" %}" >Signin</a>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let currentStep = 'step1';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showStep(stepId) {
        if (currentStep) {
            $('#' + currentStep).removeClass('active');
        }

        $('#' + stepId).addClass('active');
        currentStep = stepId;
    }

    // Step 1: Email Form
    $('#emailForm').submit(function (e) {
        e.preventDefault();
        const email = $('#email').val().trim();
        const emailError = $('#emailError');
        emailError.text('');

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            emailError.text('Please enter a valid email address.');
            return;
        }

        $.ajax({
            url: '{% url "users:send_otp" %}',
            method: 'POST',
            data: {
                email: email,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function (data) {
                if (data.message) {
                    showStep('step3');
                } else {
                    emailError.text(data.error || 'Failed to send OTP');
                }
            },
            error: function (xhr, status, error){
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred';
                emailError.text(errorMessage);
            }
        });
    });

    // Step 2: OTP Form
    $('#otpForm').submit(function (e) {
        e.preventDefault();
        const email = $('#email').val().trim();
        const otp = $('#otp').val().trim();
        const otpError = $('#otpError');
        otpError.text('');

        if (!/^\d{6}$/.test(otp)) {
            otpError.text('Enter a 6-digit OTP code');
            return;
        }

        $.ajax({
            url: '{% url "users:verify_otp" %}',
            method: 'POST',
            data: {
                email: email,
                otp_code: otp,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function (data) {
                if (data.message) {
                    showStep('step4');
                } else {
                    otpError.text(data.error || 'Invalid or expired OTP');
                }
            },
            error: function (xhr, status, error){
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred';
                otpError.text(errorMessage);
                
            }
        });
    });

    // Step 3: Password Form
    $('#passwordForm').submit(function (e) {
        e.preventDefault();
        const email = $('#email').val().trim();
        const otp = $('#otp').val().trim();
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();
        const passwordError = $('#passwordError');
        const confirmPasswordError = $('#confirmPasswordError');

        passwordError.text('');
        confirmPasswordError.text('');

        if (newPassword.length < 8) {
            passwordError.text('Password must be at least 8 characters long.');
            return;
        }

        if (newPassword !== confirmPassword) {
            confirmPasswordError.text('Passwords do not match.');
            return;
        }

        $.ajax({
            url: '{% url "users:reset_password" %}',
            method: 'POST',
            data: {
                email: email,
                otp_code: otp,
                new_password: newPassword,
                csrfmiddlewaretoken: getCookie('csrftoken')
            },
            success: function (data) {
                if (data.message) {
                    showStep('success');
                } else {
                    passwordError.text(data.error || 'Password reset failed');
                }
            },
            error: function (xhr, status, error) {
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred';
                passwordError.text(errorMessage);
                alert(errorMessage)
            }
        });
    });

    // Initialize
    $(document).ready(function () {
        showStep('step1');
    });
</script>

    {% endblock content %}