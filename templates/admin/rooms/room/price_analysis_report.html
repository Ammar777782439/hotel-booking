{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'admin/css/changelists.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --gold-primary: #D4AF37;
      --gold-secondary: #FBD341;
      --gold-light: #FFF1AA;
      --dark-primary: #222222;
      --dark-secondary: #333333;
      --dark-light: #444444;
      --white: #FFFFFF;
      --light-gray: #f8f9fa;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .report-container {
      padding: 20px;
      background-color: var(--light-gray);
      min-height: 100vh;
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--gold-primary);
      padding-bottom: 15px;
    }
    
    .report-title {
      font-size: 28px;
      margin-bottom: 10px;
      color: var(--dark-primary);
      font-weight: bold;
      position: relative;
      padding-right: 15px;
    }
    
    .report-title:before {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 5px;
      height: 80%;
      background-color: var(--gold-primary);
      border-radius: 2px;
    }
    
    .report-filters {
      background-color: var(--white);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-top: 3px solid var(--gold-primary);
    }
    
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-end;
    }
    
    .filter-group {
      margin-bottom: 0;
      min-width: 200px;
    }
    
    .filter-label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--dark-secondary);
    }
    
    select.form-control {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    select.form-control:focus {
      border-color: var(--gold-primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    
    .chart-container {
      background-color: var(--white);
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      height: 400px;
      border-top: 3px solid var(--gold-primary);
    }
    
    .chart-row {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    .chart-col {
      flex: 1;
      background-color: var(--white);
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      height: 400px;
      border-top: 3px solid var(--gold-primary);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .data-table th {
      background-color: var(--gold-primary);
      color: var(--white);
      padding: 15px;
      text-align: right;
      font-weight: 600;
      letter-spacing: 0.5px;
      font-size: 15px;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    
    .data-table tr:nth-child(even) {
      background-color: rgba(212, 175, 55, 0.05);
    }
    
    .data-table tr:hover {
      background-color: rgba(212, 175, 55, 0.1);
    }
    
    .summary-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      flex: 1;
      min-width: 220px;
      background-color: var(--white);
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      text-align: center;
      border-top: 3px solid var(--gold-primary);
      transition: transform 0.3s;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
    }
    
    .card-title {
      font-size: 15px;
      color: var(--dark-secondary);
      margin-bottom: 15px;
      font-weight: 600;
      position: relative;
      display: inline-block;
    }
    
    .card-title:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background-color: var(--gold-primary);
    }
    
    .card-value {
      font-size: 26px;
      font-weight: bold;
      color: var(--gold-primary);
      text-shadow: 1px 1px 1px rgba(0,0,0,0.05);
    }
    
    .no-data {
      text-align: center;
      padding: 50px;
      background-color: var(--white);
      border-radius: 8px;
      color: var(--dark-secondary);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-top: 3px solid var(--gold-primary);
    }
    
    .no-data h3 {
      font-size: 22px;
      margin-bottom: 15px;
      color: var(--dark-primary);
    }
    
    .no-data p {
      font-size: 16px;
      color: var(--dark-light);
    }
    
    .btn-primary {
      background-color: var(--gold-primary);
      color: var(--white);
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .btn-primary:hover {
      background-color: var(--gold-secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .price-difference {
      font-weight: bold;
    }
    
    .price-higher {
      color: #D32F2F;
    }
    
    .price-lower {
      color: #388E3C;
    }
    
    .price-equal {
      color: var(--gold-secondary);
    }
    .market-position {
      width: 100%;
      height: 25px;
      background: linear-gradient(to right, #f1f1f1, #f9f9f9, #f1f1f1);
      border-radius: 15px;
      margin-top: 20px;
      margin-bottom: 30px;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    
    .position-marker {
      position: absolute;
      top: -12px;
      width: 25px;
      height: 25px;
      background-color: var(--gold-primary);
      border-radius: 50%;
      transform: translateX(-50%);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 2;
      transition: transform 0.3s;
    }
    
    .position-marker:hover {
      transform: translateX(-50%) scale(1.1);
    }
    
    .position-marker:before {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 10px;
      height: 10px;
      background-color: var(--gold-primary);
    }
    
    .position-label {
      position: absolute;
      top: 20px;
      transform: translateX(-50%);
      font-size: 13px;
      color: var(--dark-secondary);
      font-weight: 600;
      background-color: var(--white);
      padding: 2px 8px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    
    .min-marker, .max-marker {
      position: absolute;
      top: 5px;
      font-size: 12px;
      color: var(--dark-light);
      font-weight: 500;
    }
    
    .min-marker {
      left: 5px;
    }
    
    .max-marker {
      right: 5px;
    }
    
    /* Gradient for market position */
    .market-position:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to right, 
        rgba(255, 87, 34, 0.7) 0%, /* Economic (Red) */
        rgba(255, 193, 7, 0.7) 30%, /* Value (Amber) */
        rgba(212, 175, 55, 0.7) 60%, /* Premium (Gold) */
        rgba(103, 58, 183, 0.7) 100% /* Luxury (Purple) */
      );
      border-radius: 15px;
      opacity: 0.8;
    }
  </style>
{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-list report-container{% endblock %}

{% block content %}
<div id="content-main">
  <div class="report-header">
    <h1 class="report-title">{% trans "تقرير تحليل الأسعار" %}</h1>
  </div>

  <div class="report-filters">
    <form method="get" class="filter-form">
      <div class="filter-group">
        <label class="filter-label" for="id_hotel">{% trans "الفندق" %}</label>
        <select name="hotel_id" id="id_hotel" class="form-control">
          <option value="">{% trans "جميع الفنادق" %}</option>
          {% for hotel in hotels %}
            <option value="{{ hotel.id }}" {% if selected_hotel_id == hotel.id|stringformat:"i" %}selected{% endif %}>{{ hotel.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="id_category">{% trans "تصنيف الغرفة" %}</label>
        <select name="category_id" id="id_category" class="form-control">
          <option value="">{% trans "جميع التصنيفات" %}</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if selected_category_id == category.id|stringformat:"i" %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="id_room_type">{% trans "نوع الغرفة" %}</label>
        <select name="room_type_id" id="id_room_type" class="form-control">
          <option value="">{% trans "اختر نوع الغرفة" %}</option>
          {% for room_type in room_types %}
            <option value="{{ room_type.id }}" {% if selected_room_type.id == room_type.id %}selected{% endif %}>{{ room_type.name }} ({{ room_type.hotel.name }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="id_period">{% trans "الفترة الزمنية" %}</label>
        <select name="period" id="id_period" class="form-control">
          <option value="30" {% if period == '30' %}selected{% endif %}>{% trans "آخر 30 يوم" %}</option>
          <option value="60" {% if period == '60' %}selected{% endif %}>{% trans "آخر 60 يوم" %}</option>
          <option value="90" {% if period == '90' or not period %}selected{% endif %}>{% trans "آخر 90 يوم" %}</option>
          <option value="180" {% if period == '180' %}selected{% endif %}>{% trans "آخر 180 يوم" %}</option>
          <option value="365" {% if period == '365' %}selected{% endif %}>{% trans "آخر سنة" %}</option>
        </select>
      </div>

      <div class="filter-group">
        <button type="submit" class="btn-primary">{% trans "تطبيق الفلتر" %}</button>
      </div>

      {% if pdf_export_url and selected_room_type %}
      <div class="filter-group">
        <a href="{{ pdf_export_url }}?room_type_id={{ selected_room_type.id }}&period={{ period }}&hotel_id={{ selected_hotel_id }}&category_id={{ selected_category_id }}" class="btn-primary" style="background-color: #D32F2F;">
          {% trans "تصدير PDF" %}
        </a>
      </div>
      {% endif %}
    </form>
  </div>

  {% if selected_room_type %}
    <!-- Room Type Info -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-title">{% trans "الفندق" %}</div>
        <div class="card-value">{{ selected_room_type.hotel.name }}</div>
      </div>
      <div class="summary-card">
        <div class="card-title">{% trans "نوع الغرفة" %}</div>
        <div class="card-value">{{ selected_room_type.name }}</div>
      </div>
      <div class="summary-card">
        <div class="card-title">{% trans "السعر الحالي" %}</div>
        <div class="card-value">{{ selected_room_type.base_price }}</div>
      </div>
      <div class="summary-card">
        <div class="card-title">{% trans "السعة" %}</div>
        <div class="card-value">{{ selected_room_type.default_capacity }} {% trans "أشخاص" %}</div>
      </div>
    </div>

    <!-- Market Position -->
    {% if price_statistics.market_min and price_statistics.market_max %}
    <div style="background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h3>{% trans "موقع السعر في السوق" %}</h3>
      <div class="market-position">
        <div class="position-marker" style="left: {{ price_statistics.price_position }}%;"></div>
        <div class="position-label" style="left: {{ price_statistics.price_position }}%;">{{ selected_room_type.base_price }}</div>
        <div class="min-marker">{{ price_statistics.market_min|floatformat:2 }}</div>
        <div class="max-marker">{{ price_statistics.market_max|floatformat:2 }}</div>
      </div>
      <div style="margin-top: 30px; text-align: center;">
        <p>{% trans "متوسط أسعار السوق" %}: {{ price_statistics.market_avg|floatformat:2 }}</p>
      </div>
    </div>
    {% endif %}

    <!-- Charts -->
    <div class="chart-row">
      <div class="chart-col">
        <h3 class="text-center">{% trans "تاريخ الأسعار" %}</h3>
        <canvas id="priceHistoryChart"></canvas>
      </div>
      <div class="chart-col">
        <h3 class="text-center">{% trans "مقارنة الأسعار مع المنافسين" %}</h3>
        <canvas id="competitorPricesChart"></canvas>
      </div>
    </div>

    <!-- Competitor Data Table -->
    <h3>{% trans "تفاصيل أسعار المنافسين" %}</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>{% trans "الفندق" %}</th>
          <th>{% trans "نوع الغرفة" %}</th>
          <th>{% trans "السعر" %}</th>
          <th>{% trans "الفرق" %}</th>
          <th>{% trans "نسبة الفرق" %}</th>
        </tr>
      </thead>
      <tbody>
        <!-- Current Room Type -->
        <tr>
          <td><strong>{{ selected_room_type.hotel.name }}</strong></td>
          <td><strong>{{ selected_room_type.name }}</strong></td>
          <td><strong>{{ selected_room_type.base_price }}</strong></td>
          <td>-</td>
          <td>-</td>
        </tr>

        <!-- Competitors -->
        {% for competitor in competitor_data %}
          <tr>
            <td>{{ competitor.hotel_name }}</td>
            <td>{{ competitor.room_type_name }}</td>
            <td>{{ competitor.price|floatformat:2 }}</td>
            <td>
              {% if competitor.price_difference > 0 %}
                <span class="price-difference price-higher">+{{ competitor.price_difference|floatformat:2 }}</span>
              {% elif competitor.price_difference < 0 %}
                <span class="price-difference price-lower">{{ competitor.price_difference|floatformat:2 }}</span>
              {% else %}
                <span class="price-difference price-equal">0.00</span>
              {% endif %}
            </td>
            <td>
              {% if competitor.price_difference_percent > 0 %}
                <span class="price-difference price-higher">+{{ competitor.price_difference_percent|floatformat:2 }}%</span>
              {% elif competitor.price_difference_percent < 0 %}
                <span class="price-difference price-lower">{{ competitor.price_difference_percent|floatformat:2 }}%</span>
              {% else %}
                <span class="price-difference price-equal">0.00%</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Price History Table -->
    <h3 style="margin-top: 30px;">{% trans "تاريخ الأسعار" %}</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>{% trans "التاريخ" %}</th>
          <th>{% trans "السعر" %}</th>
          <th>{% trans "نوع السعر" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for item in price_history %}
          <tr>
            <td>{{ item.date }}</td>
            <td>{{ item.price|floatformat:2 }}</td>
            <td>
              {% if item.is_special %}
                <span style="color: #D32F2F;">{% trans "عرض خاص" %}</span>
              {% else %}
                <span style="color: #388E3C;">{% trans "سعر عادي" %}</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="no-data">
      <h3>{% trans "لا توجد بيانات متاحة" %}</h3>
      <p>{% trans "يرجى اختيار نوع غرفة لعرض تحليل الأسعار" %}</p>
    </div>
  {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% if selected_room_type %}
      // Define luxury color scheme
      const goldPrimary = '#D4AF37';
      const goldSecondary = '#FBD341';
      const goldLight = '#FFF1AA';
      const darkPrimary = '#222222';
      const darkSecondary = '#333333';
      
      // Common chart options
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(34, 34, 34, 0.9)',
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            padding: 12,
            cornerRadius: 6,
            caretSize: 6,
            borderColor: goldPrimary,
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' SAR';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.05)',
              drawBorder: false
            },
            ticks: {
              font: {
                size: 12
              },
              color: darkSecondary,
              padding: 10,
              callback: function(value) {
                return value.toLocaleString() + ' SAR';
              }
            }
          },
          x: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              maxTicksLimit: 10,
              maxRotation: 45,
              minRotation: 45,
              font: {
                size: 12
              },
              color: darkSecondary,
              padding: 10
            }
          }
        }
      };
      
      // Price History Chart
      var historyDates = {{ history_dates|safe }};
      var historyPrices = {{ history_prices|safe }};

      var historyCtx = document.getElementById('priceHistoryChart').getContext('2d');
      var historyChart = new Chart(historyCtx, {
        type: 'line',
        data: {
          labels: historyDates,
          datasets: [{
            label: '{% trans "سعر الغرفة" %}',
            data: historyPrices,
            backgroundColor: 'rgba(212, 175, 55, 0.2)',
            borderColor: goldPrimary,
            borderWidth: 3,
            pointBackgroundColor: goldPrimary,
            pointBorderColor: '#fff',
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label: function(context) {
                  return '{% trans "السعر" %}: ' + context.parsed.y.toLocaleString() + ' SAR';
                }
              }
            }
          }
        }
      });

      // Competitor Prices Chart
      var competitorNames = {{ competitor_names|safe }};
      var competitorPrices = {{ competitor_prices|safe }};

      // Add current room type to the comparison
      competitorNames.unshift("{{ selected_room_type.name }}");
      competitorPrices.unshift({{ selected_room_type.base_price }});

      var competitorCtx = document.getElementById('competitorPricesChart').getContext('2d');
      var competitorChart = new Chart(competitorCtx, {
        type: 'bar',
        data: {
          labels: competitorNames,
          datasets: [{
            label: '{% trans "سعر الغرفة" %}',
            data: competitorPrices,
            backgroundColor: function(context) {
              // Highlight the current room type with gold, use a gradient for others
              if (context.dataIndex === 0) {
                return goldPrimary;
              } else {
                // Create gradient based on price (higher price = more purple/luxury)
                const value = context.dataset.data[context.dataIndex];
                const maxValue = Math.max(...context.dataset.data);
                const ratio = value / maxValue;
                
                // Gradient from economic (red) to luxury (purple)
                if (ratio < 0.3) {
                  return 'rgba(255, 87, 34, 0.7)'; // Economic (Red)
                } else if (ratio < 0.6) {
                  return 'rgba(255, 193, 7, 0.7)'; // Value (Amber)
                } else if (ratio < 0.85) {
                  return 'rgba(212, 175, 55, 0.7)'; // Premium (Gold)
                } else {
                  return 'rgba(103, 58, 183, 0.7)'; // Luxury (Purple)
                }
              }
            },
            borderColor: function(context) {
              if (context.dataIndex === 0) {
                return goldPrimary;
              } else {
                const value = context.dataset.data[context.dataIndex];
                const maxValue = Math.max(...context.dataset.data);
                const ratio = value / maxValue;
                
                if (ratio < 0.3) {
                  return 'rgb(255, 87, 34)'; // Economic (Red)
                } else if (ratio < 0.6) {
                  return 'rgb(255, 193, 7)'; // Value (Amber)
                } else if (ratio < 0.85) {
                  return 'rgb(212, 175, 55)'; // Premium (Gold)
                } else {
                  return 'rgb(103, 58, 183)'; // Luxury (Purple)
                }
              }
            },
            borderWidth: 2,
            borderRadius: 6
          }]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label: function(context) {
                  let label = '{% trans "السعر" %}: ' + context.parsed.y.toLocaleString() + ' SAR';
                  
                  // Add category for competitors
                  if (context.dataIndex > 0) {
                    const value = context.dataset.data[context.dataIndex];
                    const maxValue = Math.max(...context.dataset.data);
                    const ratio = value / maxValue;
                    
                    let category = '';
                    if (ratio < 0.3) {
                      category = '{% trans "اقتصادي" %}';
                    } else if (ratio < 0.6) {
                      category = '{% trans "متوسط" %}';
                    } else if (ratio < 0.85) {
                      category = '{% trans "فاخر" %}';
                    } else {
                      category = '{% trans "فائق الفخامة" %}';
                    }
                    
                    label += '\n{% trans "الفئة" %}: ' + category;
                  }
                  
                  return label;
                }
              }
            }
          }
        }
      });
    {% endif %}
  });
</script>
{% endblock %}
